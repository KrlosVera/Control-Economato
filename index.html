<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Aseo - Economato</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            background-color: #004aad;
            color: white;
            width: 100%;
            text-align: center;
            margin: 0;
            padding: 15px 0;
        }
        /* Nuevo estilo para el control de secciones */
        #section-control {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        #section-control label {
            font-weight: bold;
            color: #333;
        }
        #section-control input[type="number"] {
            width: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: center;
        }
        #main-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }
        /* --- Estilos de Pesta√±as (Tabs) --- */
        #tab-menu {
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            margin-bottom: 10px;
            border-bottom: 2px solid #ccc;
        }
        .tab-button {
            background-color: #f1f1f1;
            color: #333;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            font-weight: bold;
        }
        .tab-button.active {
            background-color: #004aad;
            color: white;
            border-bottom: 2px solid #004aad;
        }
        .tab-button:hover:not(.active) {
            background-color: #ddd;
        }
        /* Oculta las secciones por defecto, solo muestra la activa */
        .section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        .section.active {
            display: block;
        }
        
        /* --- Estilos de Controles y Listado (Conservados) --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        button {
            background-color: #004aad;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button#create-sections {
            background-color: #007bff;
            padding: 8px 15px;
        }
        button:hover { background-color: #00347a; }
        .person {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            margin: 6px 0;
            padding: 10px;
            border-radius: 10px;
            transition: 0.2s;
        }
        .person.done {
            background-color: #d4edda;
            text-decoration: line-through;
            color: #555;
        }
        .check-btn {
            background-color: #28a745;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .check-btn.done {
            background-color: #dc3545;
            transform: rotate(180deg);
        }
        .file-upload-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <h1>Control de Aseo - Economato</h1>
    
    <div id="section-control">
        <label for="section-count-input">Crear Secciones:</label>
        <input type="number" id="section-count-input" value="1" min="1" max="10" />
        <button id="create-sections">‚ûï Crear Secci√≥n(es)</button>
    </div>

    <div id="main-container">
        <div id="tab-menu"></div>
        <div id="sections-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc,
            getDocs,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // üîπ CONFIGURACI√ìN FIREBASE (Usa tu configuraci√≥n real)
        const firebaseConfig = {
            apiKey: "AIzaSyBqU_4EAVYl93BOPI3GM72pyEaVqW86JA4",
            authDomain: "control-aseo-economato.firebaseapp.com",
            projectId: "control-aseo-economato",
            storageBucket: "control-aseo-economato.firebasestorage.app",
            messagingSenderId: "878203215543",
            appId: "1:878203215543:web:84d9c2a4fe020f93307732",
            measurementId: "G-91Z51H1T80"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const sectionsContainer = document.getElementById("sections-container");
        const tabMenu = document.getElementById("tab-menu");
        const createSectionsBtn = document.getElementById("create-sections");
        const sectionCountInput = document.getElementById("section-count-input");
        
        let sectionCount = 0; 
        let activeSectionId = null;
        
        // üî¥ DEFINICI√ìN DE PINES DE SECCI√ìN (¬°EDITA ESTOS PINES!) üî¥
        const SECTION_PINS = {
            "seccion-1": "1234",
            "seccion-2": "4321",
            "seccion-3": "0000",
            "seccion-4": "9999",
            // Las secciones creadas din√°micamente tendr√°n el PIN "0000" por defecto.
        };

        // --- FUNCIONES DE NAVEGACI√ìN Y SEGURIDAD ---

        // üü¢ ABRIR UNA SECCI√ìN (FUNCI√ìN PRINCIPAL CON PIN)
        window.openSection = function (sectionId) {
            // 1. Obtener el PIN requerido
            const requiredPin = SECTION_PINS[sectionId] || "0000"; 

            // 2. Solicitar el PIN al usuario
            const enteredPin = prompt(`üîê Introduce el PIN para acceder a ${sectionId.replace('-', ' ').toUpperCase()}:`);

            if (enteredPin === requiredPin) {
                // PIN Correcto: Abre la secci√≥n
                
                // Desactiva todos los botones y secciones
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

                // Activa el bot√≥n y la secci√≥n seleccionada
                const tabButton = document.querySelector(`.tab-button[data-id="${sectionId}"]`);
                const sectionContent = document.getElementById(sectionId);
                
                if (tabButton && sectionContent) {
                    tabButton.classList.add('active');
                    sectionContent.classList.add('active');
                    activeSectionId = sectionId;
                } else {
                    activeSectionId = null;
                }

            } else if (enteredPin !== null) {
                // PIN Incorrecto
                alert("‚ùå PIN incorrecto. Acceso denegado.");
            }
        };

        // --- FUNCIONES DE CONTROL DE SECCIONES ---
        
        // üß© CREAR SECCI√ìN VISUAL (Ahora asigna PIN por defecto si es nueva)
        function createSection(sectionId, title) {
            if (document.getElementById(sectionId)) return;

            // Asigna un PIN por defecto si la secci√≥n no est√° en la lista inicial
            if (!SECTION_PINS[sectionId]) {
                SECTION_PINS[sectionId] = "0000"; 
            }

            // 1. Crear el bot√≥n de la pesta√±a
            const tabButton = document.createElement("button");
            tabButton.classList.add("tab-button");
            tabButton.textContent = title;
            tabButton.setAttribute('data-id', sectionId);
            tabButton.onclick = () => window.openSection(sectionId);
            tabMenu.appendChild(tabButton);

            // 2. Crear el contenido de la secci√≥n
            const section = document.createElement("div");
            section.classList.add("section");
            section.id = sectionId;
            section.innerHTML = `
                <div class="section-header">
                    <h3>${title}</h3>
                    <div class="controls">
                        <div class="file-upload-controls">
                            <input type="file" accept=".txt" id="file-${sectionId}" />
                            <button onclick="uploadTxt('${sectionId}')">üì§ Cargar TXT</button>
                        </div>
                        <button onclick="markAll('${sectionId}', true)">‚úî Todos</button>
                        <button onclick="markAll('${sectionId}', false)">‚úñ Ninguno</button>
                        <button onclick="exportTxt('${sectionId}')">‚¨á Exportar</button>
                        <button onclick="clearSection('${sectionId}')">üóë Limpiar</button>
                    </div>
                </div>
                <div class="person-list"></div>
            `;
            sectionsContainer.appendChild(section);
            
            // Ya no abrimos autom√°ticamente aqu√≠, el usuario debe usar el PIN.
        }
        
        // üü¢ CREADOR DE SECCIONES M√öLTIPLES
        createSectionsBtn.addEventListener("click", () => {
            const countToCreate = parseInt(sectionCountInput.value, 10);
            if (isNaN(countToCreate) || countToCreate < 1) {
                alert("Por favor, introduce un n√∫mero v√°lido (mayor o igual a 1).");
                return;
            }
            
            let lastSectionId = null;
            for (let i = 0; i < countToCreate; i++) {
                sectionCount++;
                const sectionId = `seccion-${sectionCount}`;
                const title = `Secci√≥n ${sectionCount}`;
                createSection(sectionId, title);
                lastSectionId = sectionId;
            }
            
            // Abrir autom√°ticamente la √∫ltima secci√≥n creada (pedir√° el PIN)
            if (lastSectionId) {
                window.openSection(lastSectionId);
            }
        });
        
        // --- FUNCIONES DE FIRESTORE (Se mantienen sin cambios) ---
        
        // üîπ MOSTRAR UNA PERSONA EN EL DOM
        window.addPersonToDOM = function (sectionId, name, done = false) {
            const listContainer = document.querySelector(`#${sectionId} .person-list`);
            if (!listContainer) return; 
            
            const personDiv = document.createElement("div");
            personDiv.classList.add("person");
            if (done) personDiv.classList.add("done");
            personDiv.innerHTML = `
                <span>${name}</span>
                <button class="check-btn ${done ? "done" : ""}">${done ? "‚úñ" : "‚úî"}</button>
            `;
            const btn = personDiv.querySelector(".check-btn");
            btn.addEventListener("click", async () => {
                const newDone = !personDiv.classList.contains("done");
                personDiv.classList.toggle("done");
                btn.classList.toggle("done");
                btn.textContent = newDone ? "‚úñ" : "‚úî";
                await setDoc(doc(db, sectionId, name), { name, done: newDone }); 
            });
            listContainer.appendChild(personDiv);
        };

        // üîπ CARGAR DATOS DE UNA SECCI√ìN Y PINTARLOS EN EL DOM
        async function loadSection(sectionId) {
            const listContainer = document.querySelector(`#${sectionId} .person-list`);
            if (!listContainer) return;
            listContainer.innerHTML = "";
            const querySnapshot = await getDocs(collection(db, sectionId));
            querySnapshot.forEach((snap) => {
                const data = snap.data();
                window.addPersonToDOM(sectionId, data.name, data.done);
            });
        }
        
        // üîπ FUNCI√ìN INTERNA PARA LIMPIAR SOLO DATOS EN FIRESTORE
        async function clearSectionData(sectionId) {
            const querySnapshot = await getDocs(collection(db, sectionId));
            const batch = [];
            querySnapshot.forEach(async (snap) => {
                batch.push(deleteDoc(doc(db, sectionId, snap.id)));
            });
            await Promise.all(batch);
        }

        // üîπ LEER ARCHIVO TXT Y SUBIRLO A FIRESTORE
        window.uploadTxt = async function (sectionId) {
            const fileInput = document.querySelector(`#file-${sectionId}`);
            const file = fileInput.files[0];
            if (!file) {
                alert("Selecciona un archivo .txt primero.");
                return;
            }
            try {
                const text = await file.text();
                const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l); 
                
                await clearSectionData(sectionId); 

                const uploadPromises = lines.map(name => {
                    return setDoc(doc(db, sectionId, name), { name, done: false }); 
                });

                await Promise.all(uploadPromises); 

                await loadSection(sectionId); 
                alert("‚úÖ Archivo cargado correctamente.");
            } catch (error) {
                console.error("Error al cargar el archivo:", error);
                alert("‚ùå Ocurri√≥ un error al procesar o subir el archivo. (Revisa la consola)");
            }
        };

        // üîπ MARCAR O DESMARCAR TODOS
        window.markAll = async function (sectionId, done) {
             const querySnapshot = await getDocs(collection(db, sectionId));
             const batch = [];
             querySnapshot.forEach((snap) => {
                 const data = snap.data();
                 batch.push(setDoc(doc(db, sectionId, data.name), { name: data.name, done }));
             });
             await Promise.all(batch);
             loadSection(sectionId);
        };

        // üîπ LIMPIAR SECCI√ìN (DOM y DB)
        window.clearSection = async function (sectionId) {
             if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres LIMPIAR y ELIMINAR la pesta√±a ${sectionId}? Esto BORRAR√Å todos los datos de forma permanente.`)) {
                 return;
             }
             
             // Aqu√≠ se podr√≠a implementar una verificaci√≥n de PIN de administrador si lo deseas.

             await clearSectionData(sectionId);
             
             // Quitar el contenido de la pesta√±a
             const sectionEl = document.getElementById(sectionId);
             if (sectionEl) sectionEl.remove();

             // Quitar el bot√≥n de la pesta√±a
             const tabButton = document.querySelector(`.tab-button[data-id="${sectionId}"]`);
             if (tabButton) tabButton.remove();
             
             // Eliminar el PIN de la lista
             delete SECTION_PINS[sectionId];
             
             // Abrir la primera pesta√±a si existe alguna
             const remainingTabs = document.querySelectorAll('.tab-button');
             if (remainingTabs.length > 0) {
                 window.openSection(remainingTabs[0].getAttribute('data-id'));
             } else {
                 activeSectionId = null;
             }
             
             alert(`‚úÖ Secci√≥n ${sectionId} limpiada y eliminada.`);
        };
        
        // üîπ EXPORTAR SECCI√ìN A TXT
        window.exportTxt = async function (sectionId) {
             const querySnapshot = await getDocs(collection(db, sectionId));
             let text = "";
             querySnapshot.forEach((snap) => {
                 const data = snap.data();
                 text += `${data.name} - ${data.done ? "‚úî Hecho" : "‚ùå Pendiente"}\n`;
             });
             const blob = new Blob([text], { type: "text/plain" });
             const link = document.createElement("a");
             link.href = URL.createObjectURL(blob);
             link.download = `${sectionId}.txt`;
             link.click();
        };

        // üü¢ CARGAR TODAS LAS SECCIONES EXISTENTES AL INICIO
        async function loadAllSections() {
            let maxSectionNumber = 0;
            let firstSectionToOpen = null;
            
            // Itera buscando colecciones 'seccion-X'
            for (let i = 1; i < 50; i++) { 
                const sectionId = `seccion-${i}`;
                const collectionRef = collection(db, sectionId);
                const querySnapshot = await getDocs(collectionRef);
                
                if (!querySnapshot.empty) {
                    maxSectionNumber = i; 
                    createSection(sectionId, `Secci√≥n ${i}`);
                    await loadSection(sectionId);
                    if (firstSectionToOpen === null) {
                        firstSectionToOpen = sectionId;
                    }
                } else if (i > maxSectionNumber + 1) {
                    break;
                }
            }
            
            // Establece el contador global para empezar la numeraci√≥n despu√©s de la √∫ltima secci√≥n encontrada.
            sectionCount = maxSectionNumber; 
            
            // Abre la primera secci√≥n encontrada (pedir√° el PIN)
            if (firstSectionToOpen) {
                 // No llamamos a openSection aqu√≠ para evitar que pida el PIN al cargar la p√°gina.
                 // Simplemente se asegura de que el bot√≥n existe para que el usuario pueda hacer clic.
            }
        }

        // üü¢ CARGA AUTOM√ÅTICA INICIAL
        loadAllSections();
    </script>
</body>
</html>
